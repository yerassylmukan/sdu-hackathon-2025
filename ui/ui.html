<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Ordering App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --dark: #1a535c;
            --light: #f7fff7;
            --warning: #ffe66d;
            --danger: #ff6b6b;
            --success: #4ecdc4;
            --text: #2f4858;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text);
            line-height: 1.6;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .page {
            display: none;
            padding: 2rem 0;
            min-height: 80vh;
        }

        .page.active {
            display: block;
        }

        /* Header */
        header {
            background-color: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 0.5rem;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: var(--primary);
        }

        .nav-link.active {
            color: var(--primary);
            font-weight: 600;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark);
            cursor: pointer;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .auth-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--dark);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-field {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #ff5252;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1rem;
        }

        .auth-switch-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        /* Food Menu */
        .categories {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .category-btn {
            white-space: nowrap;
            padding: 0.5rem 1rem;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn:hover, .category-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .foods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2rem;
        }

        .food-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .food-card:hover {
            transform: translateY(-5px);
        }

        .food-img {
            width: 100%;
            height: 180px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .food-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .food-details {
            padding: 1rem;
        }

        .food-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .food-price {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .food-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .add-to-cart {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-input {
            width: 50px;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        /* Basket */
        .basket-empty {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .basket-items {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .basket-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .basket-item-img {
            width: 80px;
            height: 80px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .basket-item-details {
            flex: 1;
        }

        .basket-item-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .basket-item-price {
            color: var(--primary);
            font-weight: 500;
        }

        .basket-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .remove-item {
            color: var(--danger);
            cursor: pointer;
            margin-left: 1rem;
        }

        .basket-summary {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .total-row {
            font-weight: bold;
            font-size: 1.1rem;
            border-top: 1px solid #f0f0f0;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
        }

        .checkout-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: background-color 0.3s;
        }

        .checkout-btn:hover {
            background-color: #3dafa7;
        }

        .clear-basket {
            text-align: center;
            color: var(--danger);
            cursor: pointer;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* Orders */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .order-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 0.75rem;
        }

        .order-number {
            font-weight: 600;
        }

        .order-date {
            color: #666;
        }

        .order-items {
            margin-bottom: 1rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .order-item-name {
            flex: 1;
        }

        .order-item-quantity {
            margin-right: 1rem;
            color: #666;
        }

        .order-item-price {
            font-weight: 500;
        }

        .order-total {
            text-align: right;
            font-weight: 600;
            padding-top: 0.75rem;
            border-top: 1px solid #f0f0f0;
        }

        /* Food Detail */
        .food-detail {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .food-detail-img {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .food-detail-content {
            padding: 2rem;
        }

        .food-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .food-detail-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .food-detail-price {
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: bold;
        }

        .food-detail-description {
            color: #666;
            margin-bottom: 2rem;
        }

        .add-to-basket-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .back-btn {
            margin-bottom: 1rem;
            display: inline-block;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
        }

        .back-btn i {
            margin-right: 0.5rem;
        }

        /* Alert */
        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            max-width: 300px;
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }

        .alert.show {
            transform: translateX(0);
        }

        .alert-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .alert-success {
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .alert-error {
            color: #721c24;
            border-left: 4px solid var(--danger);
        }

        .alert-success .alert-icon {
            color: var(--success);
        }

        .alert-error .alert-icon {
            color: var(--danger);
        }

        .alert-message {
            flex: 1;
        }

        /* Loading spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                padding: 1rem;
            }

            .nav-links {
                margin-top: 1rem;
                width: 100%;
                justify-content: space-around;
                gap: 0.5rem;
            }

            .food-detail {
                flex-direction: column;
            }

            .food-detail-img {
                height: 200px;
            }

            .food-detail-content {
                padding: 1rem;
            }
        }

        @media (max-width: 576px) {
            .header-content {
                flex-direction: row;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: white;
                padding: 1rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                margin: 0;
            }

            .nav-links.show {
                display: flex;
            }

            .mobile-menu-btn {
                display: block;
            }

            .foods-grid {
                grid-template-columns: 1fr;
            }

            .food-card {
                max-width: 100%;
            }

            .basket-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .basket-item-img {
                margin-bottom: 1rem;
                margin-right: 0;
            }

            .order-header {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo" id="home-link">
                    <i class="fas fa-utensils"></i>
                    FoodieExpress
                </a>
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
                <nav class="nav-links">
                    <a href="#" class="nav-link active" data-page="menu-page">Menu</a>
                    <a href="#" class="nav-link" data-page="basket-page">Basket</a>
                    <a href="#" class="nav-link" data-page="orders-page">My Orders</a>
                    <a href="#" class="nav-link" id="auth-link" data-page="login-page">Login</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="page" id="login-page">
            <div class="auth-container">
                <h2 class="auth-title">Login</h2>
                <form id="login-form" class="auth-form">
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" class="input-field" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" class="input-field" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
                <div class="auth-switch">
                    Don't have an account? <span class="auth-switch-link" id="go-to-register">Register</span>
                </div>
            </div>
        </div>

        <div class="page" id="register-page">
            <div class="auth-container">
                <h2 class="auth-title">Register</h2>
                <form id="register-form" class="auth-form">
                    <div class="form-group">
                        <label for="register-username">Username</label>
                        <input type="text" id="register-username" class="input-field" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" class="input-field" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-confirm-password">Confirm Password</label>
                        <input type="password" id="register-confirm-password" class="input-field" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn-primary">Register</button>
                </form>
                <div class="auth-switch">
                    Already have an account? <span class="auth-switch-link" id="go-to-login">Login</span>
                </div>
            </div>
        </div>

        <div class="page active" id="menu-page">
            <h2>Food Menu</h2>
            <div class="categories" id="categories-container">
                <button class="category-btn active" data-category-id="all">All</button>
            </div>
            <div class="foods-grid" id="foods-container">
            </div>
        </div>

        <div class="page" id="food-detail-page">
            <a href="#" class="back-btn" id="back-to-menu">
                <i class="fas fa-arrow-left"></i> Back to Menu
            </a>
            <div class="food-detail" id="food-detail-container">
            </div>
        </div>

        <div class="page" id="basket-page">
            <h2>Your Basket</h2>
            <div id="basket-content">
            </div>
        </div>

        <div class="page" id="orders-page">
            <h2>Your Orders</h2>
            <div class="orders-list" id="orders-container">
            </div>
        </div>
    </main>

    <div class="alert" id="alert">
        <div class="alert-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="alert-message"></div>
    </div>

    <script>
        document.addEventListener('click', (e) => {
            const navLinks = document.querySelector('.nav-links');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            
            if (navLinks.classList.contains('show') && 
                !navLinks.contains(e.target) && 
                !mobileMenuBtn.contains(e.target)) {
                navLinks.classList.remove('show');
            }
        });
        
        const API_BASE = "http://localhost:5000/api";
        
        async function register(userName, password) {
            try {
                const response = await fetch(`${API_BASE}/Auth/Register`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userName, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || 'Registration failed');
                }
                
                const token = await response.text();
                return { success: true, token };
            } catch (error) {
                console.error('Register error:', error);
                return { success: false, message: error.message };
            }
        }

        async function login(userName, password) {
            try {
                const response = await fetch(`${API_BASE}/Auth/Login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userName, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || 'Login failed');
                }
                
                const token = await response.text();
                return { success: true, token };
            } catch (error) {
                console.error('Login error:', error);
                return { success: false, message: error.message };
            }
        }
        
        // Basket functions
async function getUserBasket(token) {
    try {
        const response = await fetch(`${API_BASE}/Basket/GetUserBasket`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get basket');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get basket error:', error);
        return { success: false, message: error.message };
    }
}

async function addItemToBasket(token, foodId, quantity) {
    try {
        const response = await fetch(`${API_BASE}/Basket/AddItemToBasket`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ foodId, quantity })
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to add item to basket');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Add to basket error:', error);
        return { success: false, message: error.message };
    }
}

async function removeItemFromBasket(token, basketItemId) {
    try {
        const response = await fetch(`${API_BASE}/Basket/RemoveItemFromBasket/${basketItemId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to remove item from basket');
        }
        
        return { success: true };
    } catch (error) {
        console.error('Remove basket item error:', error);
        return { success: false, message: error.message };
    }
}

async function clearUserBasket(token) {
    try {
        const response = await fetch(`${API_BASE}/Basket/ClearUserBasket`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to clear basket');
        }
        
        return { success: true };
    } catch (error) {
        console.error('Clear basket error:', error);
        return { success: false, message: error.message };
    }
}

// Category functions
async function getAllCategories() {
    try {
        const response = await fetch(`${API_BASE}/Category/GetAllCategories`);
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get categories');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get categories error:', error);
        return { success: false, message: error.message };
    }
}

async function getCategoryById(id) {
    try {
        const response = await fetch(`${API_BASE}/Category/GetCategoryById/${id}`);
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get category');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get category error:', error);
        return { success: false, message: error.message };
    }
}

// Food functions
async function getAllFoods() {
    try {
        const response = await fetch(`${API_BASE}/Food/GetAllFoods`);
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get foods');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get foods error:', error);
        return { success: false, message: error.message };
    }
}

async function getFoodById(id) {
    try {
        const response = await fetch(`${API_BASE}/Food/GetFoodById/${id}`);
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get food item');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get food error:', error);
        return { success: false, message: error.message };
    }
}

// Order functions
async function placeOrderFromBasket(token) {
    try {
        const response = await fetch(`${API_BASE}/Order/PlaceOrderFromBasket`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to place order');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Place order error:', error);
        return { success: false, message: error.message };
    }
}

async function getMyOrders(token) {
    try {
        const response = await fetch(`${API_BASE}/Order/GetMyOrders`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get orders');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get orders error:', error);
        return { success: false, message: error.message };
    }
}

async function getOrderById(token, orderId) {
    try {
        const response = await fetch(`${API_BASE}/Order/GetOrderById/${orderId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to get order');
        }
        
        return await response.json();
    } catch (error) {
        console.error('Get order error:', error);
        return { success: false, message: error.message };
    }
}

        let state = {
            token: localStorage.getItem('token'),
            user: localStorage.getItem('user'),
            categories: [],
            foods: [],
            selectedCategory: 'all',
            selectedFood: null,
            basket: null,
            orders: []
        };

        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const authLink = document.getElementById('auth-link');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const navLinksContainer = document.querySelector('.nav-links');
        const homeLink = document.getElementById('home-link');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const goToRegister = document.getElementById('go-to-register');
        const goToLogin = document.getElementById('go-to-login');
        const categoriesContainer = document.getElementById('categories-container');
        const foodsContainer = document.getElementById('foods-container');
        const foodDetailContainer = document.getElementById('food-detail-container');
        const backToMenu = document.getElementById('back-to-menu');
        const basketContent = document.getElementById('basket-content');
        const ordersContainer = document.getElementById('orders-container');
        const alert = document.getElementById('alert');
        const alertMessage = alert.querySelector('.alert-message');
        const loadingOverlay = document.querySelector('.loading-overlay');

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showAlert(message, type = 'success') {
            alertMessage.textContent = message;
            alert.className = `alert alert-${type} show`;
            
            const icon = alert.querySelector('.alert-icon i');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else {
                icon.className = 'fas fa-exclamation-circle';
            }
            
            setTimeout(() => {
                alert.className = 'alert';
            }, 3000);
        }

        function navigateTo(pageId) {
            pages.forEach(page => page.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            
            navLinks.forEach(link => {
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            
            navLinksContainer.classList.remove('show');
            
            if (pageId === 'menu-page') {
                loadFoods();
            }
            
            if (pageId === 'basket-page') {
                loadBasket();
            }
            
            if (pageId === 'orders-page') {
                loadOrders();
            }
        }

        function checkAuth() {
            if (state.token) {
                authLink.textContent = 'Logout';
                authLink.dataset.page = '';
            } else {
                authLink.textContent = 'Login';
                authLink.dataset.page = 'login-page';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            state.token = null;
            state.user = null;
            checkAuth();
            showAlert('Logged out successfully');
            navigateTo('menu-page');
        }

        async function loadCategories() {
    try {
        showLoading();
        const categoriesResult = await getAllCategories();
        
        if (categoriesResult.success === false) {
            throw new Error(categoriesResult.message || 'Failed to load categories');
        }
        
        const categories = categoriesResult;
        state.categories = categories;
        
        categoriesContainer.innerHTML = '<button class="category-btn active" data-category-id="all">All</button>';
        
        categories.forEach(category => {
            const categoryBtn = document.createElement('button');
            categoryBtn.className = 'category-btn';
            categoryBtn.textContent = category.name;
            categoryBtn.dataset.categoryId = category.id;
            categoriesContainer.appendChild(categoryBtn);
        });
        
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.selectedCategory = btn.dataset.categoryId;
                loadFoods();
            });
        });
    } catch (error) {
        showAlert('Failed to load categories', 'error');
        console.error('Error loading categories:', error);
    } finally {
        hideLoading();
    }
}

async function loadFoods() {
    try {
        showLoading();
        const foodsResult = await getAllFoods();
        
        if (foodsResult.success === false) {
            throw new Error(foodsResult.message || 'Failed to load foods');
        }
        
        const foods = foodsResult;
        state.foods = foods;
        
        const filteredFoods = state.selectedCategory === 'all' 
            ? foods 
            : foods.filter(food => food.categoryId === state.selectedCategory);
        
        foodsContainer.innerHTML = '';
        
        if (filteredFoods.length === 0) {
            foodsContainer.innerHTML = '<p>No foods found in this category.</p>';
            return;
        }
        
        filteredFoods.forEach(food => {
            const foodCard = document.createElement('div');
            foodCard.className = 'food-card';
            foodCard.innerHTML = `
                <div class="food-img">
                    <img src="${food.photoUrl || '/api/placeholder/250/180'}" alt="${food.name}">
                </div>
                <div class="food-details">
                    <h3 class="food-title">${food.name}</h3>
                    <p class="food-price">$${food.price.toFixed(2)}</p>
                    <p class="food-description">${food.description || 'No description available'}</p>
                    <div class="add-to-cart">
                        <input type="number" class="quantity-input" value="1" min="1">
                        <button class="btn-primary add-to-cart-btn" data-food-id="${food.id}">Add to Cart</button>
                    </div>
                </div>
            `;
            
            foodCard.querySelector('.food-img').addEventListener('click', () => {
                viewFoodDetail(food.id);
            });
            
            foodCard.querySelector('.food-title').addEventListener('click', () => {
                viewFoodDetail(food.id);
            });
            
            foodCard.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                const quantity = parseInt(e.target.previousElementSibling.value);
                addToCart(food.id, quantity);
            });
            
            foodsContainer.appendChild(foodCard);
        });
    } catch (error) {
        showAlert('Failed to load foods', 'error');
        console.error('Error loading foods:', error);
    } finally {
        hideLoading();
    }
}

async function viewFoodDetail(foodId) {
    try {
        showLoading();
        const foodResult = await getFoodById(foodId);
        
        if (foodResult.success === false) {
            throw new Error(foodResult.message || 'Failed to load food details');
        }
        
        const food = foodResult;
        state.selectedFood = food;
        
        foodDetailContainer.innerHTML = `
            <div class="food-detail-img">
                <img src="${food.photoUrl || '/api/placeholder/400/300'}" alt="${food.name}">
            </div>
            <div class="food-detail-content">
                <div class="food-detail-header">
                    <h2 class="food-detail-title">${food.name}</h2>
                    <div class="food-detail-price">$${food.price.toFixed(2)}</div>
                </div>
                <p class="food-detail-description">${food.description || 'No description available'}</p>
                <div class="add-to-basket-container">
                    <input type="number" class="quantity-input" value="1" min="1">
                    <button class="btn-primary" id="add-to-basket-btn">Add to Basket</button>
                </div>
            </div>
        `;
        
        document.getElementById('add-to-basket-btn').addEventListener('click', () => {
            const quantity = parseInt(document.querySelector('.food-detail-content .quantity-input').value);
            addToCart(food.id, quantity);
        });
        
        navigateTo('food-detail-page');
    } catch (error) {
        showAlert('Failed to load food details', 'error');
        console.error('Error loading food details:', error);
    } finally {
        hideLoading();
    }
}

// Define a price lookup map for menu items
const foodPrices = {
  // Existing items from your menu
  "02534087-e5af-4ac2-af8b-8fe7297bfe65": 5.99, // Tomato Soup
  "0f416163-c93b-4387-a26e-7c146204da7d": 8.99, // Omelette
  "18a5648a-7a16-4e7d-997c-4b547abef615": 12.99, // Bacon Burger
  // Add more items as needed
};

// Default price if item not found
const DEFAULT_PRICE = 9.99;

async function loadBasket() {
    if (!state.token) {
        basketContent.innerHTML = `
            <div class="basket-empty">
                <p>Please login to view your basket</p>
                <button class="btn-primary" id="go-to-login-from-basket">Login</button>
            </div>
        `;
        
        document.getElementById('go-to-login-from-basket').addEventListener('click', () => {
            navigateTo('login-page');
        });
        
        return;
    }
    
    try {
        showLoading();
        const basketResult = await getUserBasket(state.token);
        
        // Debug output
        console.log('Server response:', basketResult);
        
        // Check response structure
        if (!basketResult || basketResult.success === false) {
            throw new Error(basketResult?.message || 'Failed to load basket');
        }
        
        // Determine correct basket structure based on server response
        let basket;
        if (basketResult.items) {
            basket = basketResult;
        } else if (basketResult.data) {
            basket = basketResult.data;
        } else {
            console.error('Unexpected basket structure:', basketResult);
            throw new Error('Invalid basket data structure');
        }
        
        state.basket = basket;
        
        // Check if basket is empty
        if (!basket.items || basket.items.length === 0) {
            basketContent.innerHTML = `
                <div class="basket-empty">
                    <p>Your basket is empty</p>
                    <button class="btn-primary" id="go-to-menu-from-basket">Browse Menu</button>
                </div>
            `;
            
            document.getElementById('go-to-menu-from-basket').addEventListener('click', () => {
                navigateTo('menu-page');
            });
            
            return;
        }
        
        let subtotal = 0;
        let itemsHtml = '';
        
        // Process basket items 
        basket.items.forEach(item => {
            // Get price from our price lookup table
            let price = 0;
            
            if (item.foodId && foodPrices[item.foodId]) {
                price = foodPrices[item.foodId];
            } else {
                price = DEFAULT_PRICE;
                console.warn(`Price not found for food ID ${item.foodId}, using default price ${DEFAULT_PRICE}`);
            }
            
            const quantity = item.quantity || 1;
            const itemTotal = price * quantity;
            subtotal += itemTotal;
            
            const name = item.foodName || 'Unknown Item';
            const itemId = item.id || '';
            
            itemsHtml += `
                <div class="basket-item">
                    <div class="basket-item-details">
                        <h3 class="basket-item-title">${name}</h3>
                        <p class="basket-item-price">$${price.toFixed(2)}</p>
                        <div class="basket-item-quantity">
                            <span>Quantity: ${quantity}</span>
                            <span class="remove-item" data-item-id="${itemId}">
                                <i class="fas fa-trash"></i> Remove
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        const deliveryFee = 2.99;
        const total = subtotal + deliveryFee;
        
        basketContent.innerHTML = `
            <div class="basket-items">
                ${itemsHtml}
            </div>
            <div class="basket-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>$${subtotal.toFixed(2)}</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Fee</span>
                    <span>$${deliveryFee.toFixed(2)}</span>
                </div>
                <div class="summary-row total-row">
                    <span>Total</span>
                    <span>$${total.toFixed(2)}</span>
                </div>
                <button class="checkout-btn" id="checkout-btn">Checkout</button>
                <div class="clear-basket" id="clear-basket">Clear Basket</div>
            </div>
        `;
        
        // Add event listeners after DOM is updated
        setTimeout(() => {
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const itemId = btn.dataset.itemId;
                    const removeResult = await removeItemFromBasket(state.token, itemId);
                    
                    if (removeResult.success) {
                        loadBasket();
                        showAlert('Item removed from basket');
                    } else {
                        showAlert(removeResult.message || 'Failed to remove item', 'error');
                    }
                });
            });
            
            document.getElementById('checkout-btn').addEventListener('click', async () => {
                try {
                    showLoading();
                    const orderResult = await placeOrderFromBasket(state.token);
                    
                    if (orderResult.success === false) {
                        throw new Error(orderResult.message || 'Failed to place order');
                    }
                    
                    showAlert('Order placed successfully');
                    loadBasket();
                    navigateTo('orders-page');
                } catch (error) {
                    showAlert('Failed to place order', 'error');
                    console.error('Error placing order:', error);
                } finally {
                    hideLoading();
                }
            });
            
            document.getElementById('clear-basket').addEventListener('click', async () => {
                try {
                    showLoading();
                    const clearResult = await clearUserBasket(state.token);
                    
                    if (clearResult.success === false) {
                        throw new Error(clearResult.message || 'Failed to clear basket');
                    }
                    
                    showAlert('Basket cleared');
                    loadBasket();
                } catch (error) {
                    showAlert('Failed to clear basket', 'error');
                    console.error('Error clearing basket:', error);
                } finally {
                    hideLoading();
                }
            });
        }, 0);
    } catch (error) {
        showAlert('Failed to load basket', 'error');
        console.error('Error loading basket:', error);
        
        basketContent.innerHTML = `
            <div class="basket-empty">
                <p>Could not load your basket</p>
                <button class="btn-primary" id="try-reload-basket">Try Again</button>
            </div>
        `;
        
        document.getElementById('try-reload-basket')?.addEventListener('click', () => {
            loadBasket();
        });
    } finally {
        hideLoading();
    }
}

async function addToCart(foodId, quantity) {
    if (!state.token) {
        showAlert('Please login to add items to your basket', 'error');
        navigateTo('login-page');
        return;
    }
    
    try {
        showLoading();
        const result = await addItemToBasket(state.token, foodId, quantity);
        
        if (result.success === false) {
            throw new Error(result.message || 'Failed to add item to basket');
        }
        
        showAlert('Item added to basket');
    } catch (error) {
        showAlert('Failed to add item to basket', 'error');
        console.error('Error adding item to basket:', error);
    } finally {
        hideLoading();
    }
}

async function loadOrders() {
    if (!state.token) {
        ordersContainer.innerHTML = `
            <div class="basket-empty">
                <p>Please login to view your orders</p>
                <button class="btn-primary" id="go-to-login-from-orders">Login</button>
            </div>
        `;
        
        document.getElementById('go-to-login-from-orders').addEventListener('click', () => {
            navigateTo('login-page');
        });
        
        return;
    }
    
    try {
        showLoading();
        const response = await getMyOrders(state.token);
        
        // Check server response
        if (!response || response.success === false) {
            throw new Error(response?.message || 'Failed to load orders');
        }
        
        // Get data from server response
        const orders = response.orders || response || [];
        state.orders = orders;
        
        if (!orders || orders.length === 0) {
            ordersContainer.innerHTML = `
                <div class="basket-empty">
                    <p>You have no orders yet</p>
                    <button class="btn-primary" id="go-to-menu-from-orders">Browse Menu</button>
                </div>
            `;
            
            document.getElementById('go-to-menu-from-orders').addEventListener('click', () => {
                navigateTo('menu-page');
            });
            
            return;
        }
        
        let ordersHtml = '';
        
        orders.forEach(order => {
            let orderItemsHtml = '';
            let orderTotal = 0;
            let deliveryFee = 2.99; // Same delivery fee as in basket
            
            const items = order.items || [];
            
            items.forEach(item => {
                const itemName = item.foodName || 'Unknown Item';
                
                // Get price from our price lookup table, same as in loadBasket
                let itemPrice = 0;
                if (item.foodId && foodPrices[item.foodId]) {
                    itemPrice = foodPrices[item.foodId];
                } else {
                    itemPrice = DEFAULT_PRICE;
                    console.warn(`Price not found for food ID ${item.foodId}, using default price ${DEFAULT_PRICE}`);
                }
                
                const itemQuantity = parseInt(item.quantity) || 1;
                const itemTotal = itemPrice * itemQuantity;
                orderTotal += itemTotal;
                
                orderItemsHtml += `
                    <div class="order-item">
                        <span class="order-item-name">${itemName}</span>
                        <span class="order-item-price">$${itemPrice.toFixed(2)}</span>
                        <span class="order-item-quantity">x${itemQuantity}</span>
                        <span class="order-item-total">$${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });
            
            // Add delivery fee to total
            const finalTotal = orderTotal + deliveryFee;
            
            // Format date to be more readable
            const orderDate = new Date(order.createdAt).toLocaleString();
            const orderId = order.id;
            const orderStatus = order.status;
            
            ordersHtml += `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">Order #${orderId}</div>
                        <div class="order-date">${orderDate}</div>
                        <div class="order-status">Status: ${orderStatus}</div>
                    </div>
                    <div class="order-items">
                        ${orderItemsHtml}
                    </div>
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>$${orderTotal.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span>$${deliveryFee.toFixed(2)}</span>
                        </div>
                        <div class="summary-row total-row">
                            <span>Total</span>
                            <span>$${finalTotal.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        ordersContainer.innerHTML = ordersHtml;
    } catch (error) {
        showAlert('Failed to load orders', 'error');
        console.error('Error loading orders:', error);
        
        // Show error to user
        ordersContainer.innerHTML = `
            <div class="basket-empty">
                <p>Error loading orders: ${error.message}</p>
                <button class="btn-primary" id="retry-orders">Retry</button>
            </div>
        `;
        
        document.getElementById('retry-orders')?.addEventListener('click', () => {
            loadOrders();
        });
    } finally {
        hideLoading();
    }
}

async function updateQuantity(basketItemId, newQuantity) {
    if (!state.token) {
        showAlert('Please login to update your basket', 'error');
        navigateTo('login-page');
        return Promise.reject('Not authenticated');
    }
    
    try {
        showLoading();
        const response = await fetch(`${API_BASE}/Basket/UpdateItemQuantity`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${state.token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ basketItemId, quantity: newQuantity })
        });
        
        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(errorData || 'Failed to update quantity');
        }
        
        showAlert('Quantity updated');
        loadBasket();
        return { success: true };
    } catch (error) {
        showAlert('Failed to update quantity', 'error');
        console.error('Error updating quantity:', error);
        return { success: false, message: error.message };
    } finally {
        hideLoading();
    }
}

        function handleWindowResize() {
            const windowWidth = window.innerWidth;
            
            if (windowWidth > 576) {
                navLinksContainer.classList.remove('show');
                navLinksContainer.style.display = windowWidth > 576 ? 'flex' : 'none';
            }
            
            if (windowWidth < 576) {
                foodsContainer.classList.add('single-column');
            } else {
                foodsContainer.classList.remove('single-column');
            }
        }

        function applyDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        function toggleDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            localStorage.setItem('darkMode', !darkMode);
            applyDarkMode();
        }

        function searchFoods(query) {
            if (!query) {
                loadFoods();
                return;
            }
            
            query = query.toLowerCase();
            const filteredFoods = state.foods.filter(food => 
                food.name.toLowerCase().includes(query) || 
                (food.description && food.description.toLowerCase().includes(query))
            );
            
            foodsContainer.innerHTML = '';
            
            if (filteredFoods.length === 0) {
                foodsContainer.innerHTML = `<p>No foods found matching "${query}".</p>`;
                return;
            }
            
            filteredFoods.forEach(food => {
                const foodCard = document.createElement('div');
                foodCard.className = 'food-card';
                foodCard.innerHTML = `
                    <div class="food-img">
                        <img src="${food.imageUrl || '/api/placeholder/250/180'}" alt="${food.name}">
                    </div>
                    <div class="food-details">
                        <h3 class="food-title">${food.name}</h3>
                        <p class="food-price">${food.price.toFixed(2)}</p>
                        <p class="food-description">${food.description || 'No description available'}</p>
                        <div class="add-to-cart">
                            <input type="number" class="quantity-input" value="1" min="1">
                            <button class="btn-primary add-to-cart-btn" data-food-id="${food.id}">Add to Cart</button>
                        </div>
                    </div>
                `;
                
                foodCard.querySelector('.food-img').addEventListener('click', () => {
                    viewFoodDetail(food.id);
                });
                
                foodCard.querySelector('.food-title').addEventListener('click', () => {
                    viewFoodDetail(food.id);
                });
                
                foodCard.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    const quantity = parseInt(e.target.previousElementSibling.value);
                    addToCart(food.id, quantity);
                });
                
                foodsContainer.appendChild(foodCard);
            });
        }

        function updateBasketBadge() {
            const basketBadge = document.getElementById('basket-badge');
            
            if (!state.token || !state.basket || !state.basket.items || state.basket.items.length === 0) {
                if (basketBadge) {
                    basketBadge.style.display = 'none';
                }
                return;
            }
            
            const itemCount = state.basket.items.reduce((total, item) => total + item.quantity, 0);
            
            if (basketBadge) {
                basketBadge.textContent = itemCount;
                basketBadge.style.display = 'flex';
            } else {
                const badge = document.createElement('span');
                badge.id = 'basket-badge';
                badge.className = 'badge';
                badge.textContent = itemCount;
                
                const basketLink = Array.from(navLinks).find(link => link.dataset.page === 'basket-page');
                if (basketLink) {
                    basketLink.style.position = 'relative';
                    basketLink.appendChild(badge);
                }
            }
        }

        function addSearchBar() {
            const menuPage = document.getElementById('menu-page');
            const foodsContainer = document.getElementById('foods-container');
            
            if (!document.getElementById('search-container')) {
                const searchContainer = document.createElement('div');
                searchContainer.id = 'search-container';
                searchContainer.className = 'search-container';
                searchContainer.innerHTML = `
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search foods...">
                        <button id="search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                `;
                
                const categoriesContainer = document.getElementById('categories-container');
                menuPage.insertBefore(searchContainer, categoriesContainer.nextSibling);
                
                const searchInput = document.getElementById('search-input');
                const searchButton = document.getElementById('search-button');
                
                searchInput.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') {
                        searchFoods(searchInput.value);
                    }
                });
                
                searchButton.addEventListener('click', () => {
                    searchFoods(searchInput.value);
                });
            }
        }

        function addResponsiveStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .search-container {
                    margin: 1rem 0;
                }
                
                .search-box {
                    display: flex;
                    max-width: 500px;
                    margin: 0 auto;
                }
                
                .search-box input {
                    flex: 1;
                    padding: 0.75rem;
                    border: 1px solid #ddd;
                    border-radius: 4px 0 0 4px;
                    font-size: 1rem;
                }
                
                .search-box button {
                    background-color: var(--primary);
                    color: white;
                    border: none;
                    padding: 0.75rem 1rem;
                    border-radius: 0 4px 4px 0;
                    cursor: pointer;
                }
                
                .badge {
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background-color: var(--primary);
                    color: white;
                    font-size: 0.75rem;
                    width: 18px;
                    height: 18px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .dark-mode {
                    background-color: #121212;
                    color: #f5f5f5;
                }
                
                .dark-mode header,
                .dark-mode .auth-container,
                .dark-mode .food-card,
                .dark-mode .basket-items,
                .dark-mode .basket-summary,
                .dark-mode .order-card,
                .dark-mode .food-detail {
                    background-color: #1e1e1e;
                    color: #f5f5f5;
                }
                
                .dark-mode .nav-link {
                    color: #f5f5f5;
                }
                
                .dark-mode .input-field {
                    background-color: #2c2c2c;
                    color: #f5f5f5;
                    border-color: #333;
                }
                
                .dark-mode .food-description,
                .dark-mode .order-date {
                    color: #aaa;
                }
                
                @media (max-width: 576px) {
                    .search-container {
                        padding: 0 1rem;
                    }
                    
                    .basket-badge {
                        right: 0;
                    }
                }
            `;
            
            document.head.appendChild(style);
        }

        function addScrollToTopButton() {
            const scrollBtn = document.createElement('button');
            scrollBtn.id = 'scroll-top-btn';
            scrollBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
            scrollBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: var(--primary);
                color: white;
                border: none;
                display: none;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 99;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(scrollBtn);
            
            window.addEventListener('scroll', () => {
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                    scrollBtn.style.display = 'flex';
                } else {
                    scrollBtn.style.display = 'none';
                }
            });
            
            scrollBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

        function initApp() {
            addResponsiveStyles();
            
            addScrollToTopButton();
            
            checkAuth();
            
            loadCategories();
            loadFoods();
            
            addSearchBar();
            
            applyDarkMode();
            
            homeLink.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('menu-page');
            });
            
            mobileMenuBtn.addEventListener('click', () => {
                navLinksContainer.classList.toggle('show');
            });
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    if (link.id === 'auth-link' && state.token) {
                        logout();
                        return;
                    }
                    
                    if (link.dataset.page) {
                        navigateTo(link.dataset.page);
                    }
                });
            });
            
            backToMenu.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('menu-page');
            });
            
            window.addEventListener('resize', handleWindowResize);
            handleWindowResize();
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                try {
                    showLoading();
                    const response = await login(username, password);
                    
                    if (response.success && response.token) {
                        localStorage.setItem('token', response.token);
                        localStorage.setItem('user', username);
                        state.token = response.token;
                        state.user = username;
                        checkAuth();
                        showAlert('Logged in successfully');
                        loginForm.reset();
                        loadBasket();
                        navigateTo('menu-page');
                    } else {
                        showAlert(response.message || 'Invalid credentials', 'error');
                    }
                } catch (error) {
                    showAlert('Login failed', 'error');
                    console.error('Login error:', error);
                } finally {
                    hideLoading();
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (password !== confirmPassword) {
                    showAlert('Passwords do not match', 'error');
                    return;
                }
                
                try {
                    showLoading();
                    const response = await register(username, password);
                    
                    if (response.success) {
                        showAlert('Registration successful, please login');
                        registerForm.reset();
                        navigateTo('login-page');
                    } else {
                        showAlert(response.message || 'Registration failed', 'error');
                    }
                } catch (error) {
                    showAlert('Registration failed', 'error');
                    console.error('Registration error:', error);
                } finally {
                    hideLoading();
                }
            });
            
            goToRegister.addEventListener('click', () => {
                navigateTo('register-page');
            });
            
            goToLogin.addEventListener('click', () => {
                navigateTo('login-page');
            });
            
            const headerContent = document.querySelector('.header-content');
            const darkModeBtn = document.createElement('button');
            darkModeBtn.className = 'dark-mode-toggle';
            darkModeBtn.innerHTML = '<i class="fas fa-moon"></i>';
            darkModeBtn.style.cssText = `
                background: none;
                border: none;
                font-size: 1.2rem;
                color: var(--dark);
                cursor: pointer;
                margin-left: 1rem;
            `;
            darkModeBtn.addEventListener('click', toggleDarkMode);
            headerContent.appendChild(darkModeBtn);
            
            window.addEventListener('online', () => {
                showAlert('You are back online', 'success');
                loadFoods();
                if (state.token) {
                    loadBasket();
                    loadOrders();
                }
            });
            
            window.addEventListener('offline', () => {
                showAlert('You are offline. Some features may be limited.', 'error');
            });
            
            if (state.token) {
                setInterval(async () => {
                    try {
                        const basket = await getUserBasket(state.token);
                        state.basket = basket;
                        updateBasketBadge();
                    } catch (error) {
                        console.log('Background basket refresh failed:', error);
                    }
                }, 60000);
            }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }
        }

        function handleDeviceOrientation() {
            window.addEventListener('orientationchange', () => {
                handleWindowResize();
                
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    
                    const activePage = document.querySelector('.page.active');
                    if (activePage) {
                        const pageId = activePage.id;
                        if (pageId === 'menu-page') {
                            loadFoods();
                        } else if (pageId === 'basket-page') {
                            loadBasket();
                        } else if (pageId === 'orders-page') {
                            loadOrders();
                        }
                    }
                }, 300);
            });
        }

        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                const lazyImageObserver = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const lazyImage = entry.target;
                            if (lazyImage.dataset.src) {
                                lazyImage.src = lazyImage.dataset.src;
                                lazyImage.removeAttribute('data-src');
                                lazyImageObserver.unobserve(lazyImage);
                            }
                        }
                    });
                });
                
                document.addEventListener('DOMContentLoaded', () => {
                    const lazyImages = document.querySelectorAll('img[data-src]');
                    lazyImages.forEach(img => lazyImageObserver.observe(img));
                });
                
                const checkForNewImages = () => {
                    const newLazyImages = document.querySelectorAll('img[data-src]:not([src])');
                    newLazyImages.forEach(img => lazyImageObserver.observe(img));
                };
                
                const originalLoadFoods = window.loadFoods;
                window.loadFoods = function() {
                    originalLoadFoods.apply(this, arguments);
                    setTimeout(checkForNewImages, 100);
                };
            }
        }

        function checkForAppInstall() {
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                const installButton = document.createElement('button');
                installButton.id = 'install-app';
                installButton.innerHTML = '<i class="fas fa-download"></i> Install App';
                installButton.className = 'install-button';
                installButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    padding: 0.5rem 1rem;
                    background-color: var(--success);
                    color: white;
                    border: none;
                    border-radius: 4px;
                    font-size: 0.9rem;
                    z-index: 99;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                `;
                
                document.body.appendChild(installButton);
                
                installButton.addEventListener('click', async () => {
                    installButton.style.display = 'none';
                    
                    deferredPrompt.prompt();
                    
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    deferredPrompt = null;
                    
                    if (outcome === 'accepted') {
                        showAlert('App installed successfully!');
                    } else {
                        installButton.style.display = 'flex';
                    }
                });
            });
            
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                showAlert('Thank you for installing our app!');
                
                const installButton = document.getElementById('install-app');
                if (installButton) {
                    installButton.style.display = 'none';
                }
            });
        }

        function enhanceTouchExperience() {
            let touchStartX = 0;
            let touchEndX = 0;
            
            const handleSwipe = (element) => {
                element.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, {passive: true});
                
                element.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipeGesture();
                }, {passive: true});
            };
            
            const handleSwipeGesture = () => {
                const MIN_SWIPE_DISTANCE = 100;
                
                if (touchEndX < touchStartX - MIN_SWIPE_DISTANCE) {
                    const activePageIndex = Array.from(pages).findIndex(page => page.classList.contains('active'));
                    const nextPageIndex = (activePageIndex + 1) % pages.length;
                    
                    if (nextPageIndex !== activePageIndex && pages[nextPageIndex].id !== 'login-page' && 
                        pages[nextPageIndex].id !== 'register-page') {
                        navigateTo(pages[nextPageIndex].id);
                    }
                }
                
                if (touchEndX > touchStartX + MIN_SWIPE_DISTANCE) {
                    const activePageIndex = Array.from(pages).findIndex(page => page.classList.contains('active'));
                    const prevPageIndex = activePageIndex === 0 ? pages.length - 1 : activePageIndex - 1;
                    
                    if (prevPageIndex !== activePageIndex && pages[prevPageIndex].id !== 'login-page' && 
                        pages[prevPageIndex].id !== 'register-page') {
                        navigateTo(pages[prevPageIndex].id);
                    }
                }
            };
            
            const mainContainer = document.querySelector('main.container');
            if (mainContainer) {
                handleSwipe(mainContainer);
            }
            
            document.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    const button = e.target.tagName === 'BUTTON' ? e.target : e.target.closest('button');
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        button.style.transform = '';
                    }, 150);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            registerServiceWorker();
            
            handleDeviceOrientation();
            
            setupLazyLoading();
            
            checkForAppInstall();
            
            enhanceTouchExperience();
        });

    </script>
</body>
</html>