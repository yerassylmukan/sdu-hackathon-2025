<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Admin Dashboard</title>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --accent: #FF9800;
            --danger: #F44336;
            --success: #8BC34A;
            --gray: #f5f5f5;
            --dark: #424242;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9f9f9;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .sidebar {
            width: 250px;
            background-color: var(--dark);
            color: var(--white);
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
        }

        .sidebar h1 {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.5rem;
        }

        .sidebar-menu {
            margin-top: 30px;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: var(--white);
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 25px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            color: var(--dark);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background-color: #D32F2F;
        }

        .btn-accent {
            background-color: var(--accent);
            color: var(--white);
        }

        .btn-accent:hover {
            background-color: #FB8C00;
        }

        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background-color: #f3f3f3;
            font-weight: 600;
            color: var(--dark);
        }

        table tr:hover {
            background-color: #f9f9f9;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-control-file {
            width: 100%;
            padding: 10px 0;
        }

        .recipe-items {
            margin-top: 10px;
        }

        .recipe-item {
            display: flex;
            margin-bottom: 5px;
        }

        .recipe-item input {
            flex: 1;
            margin-right: 5px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--dark);
        }

        .close-modal {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .hidden {
            display: none;
        }

        .admin-actions {
            margin-top: 20px;
        }

        /* Alert message */
        .alert {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .alert-success {
            background-color: #DFF2BF;
            color: #4F8A10;
            border: 1px solid #4F8A10;
        }

        .alert-danger {
            background-color: #FFBABA;
            color: #D8000C;
            border: 1px solid #D8000C;
        }

        #message {
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }
        }

        .food-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            object-fit: cover;
            border-radius: 4px;
        }

        .food-table-img {
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .actions-col {
            display: flex;
            gap: 5px;
        }

        /* Admin role section */
        .admin-role-section {
            margin-top: 30px;
        }

        // sfslknfslk
           .status-slider {
               width: 100%;
               margin: 10px 0;
           }

        .status-label {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .order-status-cell {
            min-width: 200px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-preparing {
            background-color: #FFF3CD;
            color: #856404;
        }

        .status-delivering {
            background-color: #CCE5FF;
            color: #004085;
        }

        .status-delivered {
            background-color: #D4EDDA;
            color: #155724;
        }
    </style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage">
    <div class="login-container">
        <h2>Admin Login</h2>
        <div id="loginMessage"></div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
    </div>
</div>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="hidden">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>Food Admin</h1>
            <div class="sidebar-menu">
                <a href="#" class="active" data-section="dashboardSection">Dashboard</a>
                <a href="#" data-section="categoriesSection">Categories</a>
                <a href="#" data-section="foodsSection">Foods</a>
                <a href="#" data-section="adminRolesSection">Admin Roles</a>
                <a href="#" data-section="ordersSection">Orders</a>
                <a href="#" id="logoutBtn">Logout</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section-content">
                <div class="header">
                    <h2>Dashboard</h2>
                </div>
                <div class="card">
                    <h3>Welcome to Food Admin Dashboard</h3>
                    <p>Use the sidebar to navigate between different sections.</p>
                </div>
                <div class="row">
                    <div class="card">
                        <h3>Statistics</h3>
                        <div id="statistics">
                            <p>Categories: <span id="categoryCount">0</span></p>
                            <p>Foods: <span id="foodCount">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categoriesSection" class="section-content hidden">
                <div class="header">
                    <h2>Categories</h2>
                    <button class="btn btn-primary" id="addCategoryBtn">Add Category</button>
                </div>
                <div class="card">
                    <table id="categoriesTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Categories data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Foods Section -->
            <div id="foodsSection" class="section-content hidden">
                <div class="header">
                    <h2>Foods</h2>
                    <button class="btn btn-primary" id="addFoodBtn">Add Food</button>
                </div>
                <div class="card">
                    <table id="foodsTable">
                        <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Foods data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Roles Section -->
            <div id="adminRolesSection" class="section-content hidden">
                <div class="header">
                    <h2>Admin Roles</h2>
                </div>
                <div class="card">
                    <h3>Grant Admin Role</h3>
                    <form id="grantAdminForm">
                        <div class="form-group">
                            <label for="adminUsername">Username</label>
                            <input type="text" id="adminUsername" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Grant Admin Role</button>
                    </form>
                    <div id="adminRoleMessage" class="mt-3"></div>
                </div>
            </div>

            <div id="ordersSection" class="section-content hidden">
                <div class="header">
                    <h2>Orders</h2>
                </div>
                <div class="card">
                    <table id="ordersTable">
                        <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Orders data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="categoryModalTitle">Add Category</h3>
            <span class="close-modal" id="closeCategoryModal">&times;</span>
        </div>
        <form id="categoryForm">
            <input type="hidden" id="categoryId">
            <div class="form-group">
                <label for="categoryName">Category Name</label>
                <input type="text" id="categoryName" class="form-control" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="cancelCategoryBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Food Modal -->
<div id="foodModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="foodModalTitle">Add Food</h3>
            <span class="close-modal" id="closeFoodModal">&times;</span>
        </div>
        <form id="foodForm">
            <input type="hidden" id="foodId">
            <div class="form-group">
                <label for="foodName">Food Name</label>
                <input type="text" id="foodName" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="foodDescription">Description</label>
                <textarea id="foodDescription" class="form-control" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="foodPhotoUrl">Photo URL</label>
                <input type="url" id="foodPhotoUrl" class="form-control" required>
                <img id="foodPhotoPreview" class="food-preview hidden" alt="Food preview">
            </div>
            <div class="form-group">
                <label for="foodPrice">Price ($)</label>
                <input type="number" id="foodPrice" class="form-control" min="0" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="foodPrepTime">Preparation Time (minutes)</label>
                <input type="number" id="foodPrepTime" class="form-control" min="0" required>
            </div>
            <div class="form-group">
                <label for="foodCategory">Category</label>
                <select id="foodCategory" class="form-control" required>
                    <option value="">Select Category</option>
                    <!-- Categories will be loaded here -->
                </select>
            </div>
            <div class="form-group">
                <label>Recipe Steps</label>
                <div id="recipeSteps">
                    <div class="recipe-item">
                        <input type="text" class="form-control recipe-step" placeholder="Step 1" required>
                        <button type="button" class="btn btn-danger remove-step">X</button>
                    </div>
                </div>
                <button type="button" class="btn btn-accent" id="addStepBtn">Add Step</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="cancelFoodBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:5000/api';

    // DOM elements
    const loginPage = document.getElementById('loginPage');
    const adminDashboard = document.getElementById('adminDashboard');
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');
    const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
    const sections = document.querySelectorAll('.section-content');
    const logoutBtn = document.getElementById('logoutBtn');

    // Category elements
    const categoriesTable = document.getElementById('categoriesTable');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryModal = document.getElementById('categoryModal');
    const categoryForm = document.getElementById('categoryForm');
    const closeCategoryModal = document.getElementById('closeCategoryModal');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
    const categoryModalTitle = document.getElementById('categoryModalTitle');

    // Food elements
    const foodsTable = document.getElementById('foodsTable');
    const addFoodBtn = document.getElementById('addFoodBtn');
    const foodModal = document.getElementById('foodModal');
    const foodForm = document.getElementById('foodForm');
    const closeFoodModal = document.getElementById('closeFoodModal');
    const cancelFoodBtn = document.getElementById('cancelFoodBtn');
    const foodModalTitle = document.getElementById('foodModalTitle');
    const foodPhotoUrl = document.getElementById('foodPhotoUrl');
    const foodPhotoPreview = document.getElementById('foodPhotoPreview');
    const addStepBtn = document.getElementById('addStepBtn');
    const recipeSteps = document.getElementById('recipeSteps');

    // Admin role elements
    const grantAdminForm = document.getElementById('grantAdminForm');
    const adminRoleMessage = document.getElementById('adminRoleMessage');

    // Statistics elements
    const categoryCount = document.getElementById('categoryCount');
    const foodCount = document.getElementById('foodCount');

    // Order status constants
    const ORDER_STATUS = {
        PREPARING: 0,
        DELIVERING: 1,
        DELIVERED: 2
    };

    // Status display text
    const STATUS_TEXT = {
        0: "Preparing",
        1: "Delivering",
        2: "Delivered"
    };

    // Check authentication on page load
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('adminToken');
        if (token) {
            showAdminDashboard();
            loadDashboardData();
        }
    });

    // Login form submission
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${API_BASE_URL}/Auth/Login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userName: username, password: password })
            });

            const data = await response.text();

            if (response.ok) {
                // Store JWT token in local storage
                localStorage.setItem('adminToken', data);
                showAdminDashboard();
                loadDashboardData();
            } else {
                loginMessage.innerHTML = `<div class="alert alert-danger">Login failed: ${data}</div>`;
            }
        } catch (error) {
            loginMessage.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });

    // Logout functionality
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('adminToken');
        showLoginPage();
    });

    // Navigation between sections
    sidebarLinks.forEach(link => {
        if (link.id !== 'logoutBtn') {
            link.addEventListener('click', () => {
                const sectionId = link.getAttribute('data-section');

                // Toggle active class on sidebar links
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Show selected section and hide others
                sections.forEach(section => {
                    if (section.id === sectionId) {
                        section.classList.remove('hidden');

                        // Load data for the selected section
                        if (sectionId === 'categoriesSection') {
                            loadCategories();
                        } else if (sectionId === 'foodsSection') {
                            loadFoods();
                            loadCategoriesForDropdown();
                        } else if (sectionId === 'ordersSection') {
                            loadOrders();
                        }
                    } else {
                        section.classList.add('hidden');
                    }
                });
            });
        }
    });

    // Category modal handlers
    addCategoryBtn.addEventListener('click', () => {
        categoryModalTitle.textContent = 'Add Category';
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryName').value = '';
        categoryModal.style.display = 'block';
    });

    closeCategoryModal.addEventListener('click', () => {
        categoryModal.style.display = 'none';
    });

    cancelCategoryBtn.addEventListener('click', () => {
        categoryModal.style.display = 'none';
    });

    // Category form submission
    categoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const categoryId = document.getElementById('categoryId').value;
        const categoryName = document.getElementById('categoryName').value;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            let url = `${API_BASE_URL}/Category/CreateCategory`;
            let method = 'POST';

            if (categoryId) {
                url = `${API_BASE_URL}/Category/UpdateCategory/${categoryId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name: categoryName })
            });

            if (response.ok) {
                categoryModal.style.display = 'none';
                loadCategories();
                loadDashboardData();
            } else {
                const errorData = await response.text();
                alert(`Error: ${errorData}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    // Food modal handlers
    addFoodBtn.addEventListener('click', () => {
        foodModalTitle.textContent = 'Add Food';
        document.getElementById('foodId').value = '';
        document.getElementById('foodName').value = '';
        document.getElementById('foodDescription').value = '';
        document.getElementById('foodPhotoUrl').value = '';
        document.getElementById('foodPrice').value = '';
        document.getElementById('foodPrepTime').value = '';
        document.getElementById('foodCategory').value = '';

        // Reset recipe steps
        recipeSteps.innerHTML = `
                <div class="recipe-item">
                    <input type="text" class="form-control recipe-step" placeholder="Step 1" required>
                    <button type="button" class="btn btn-danger remove-step">X</button>
                </div>
            `;

        foodPhotoPreview.classList.add('hidden');
        foodModal.style.display = 'block';
    });

    closeFoodModal.addEventListener('click', () => {
        foodModal.style.display = 'none';
    });

    cancelFoodBtn.addEventListener('click', () => {
        foodModal.style.display = 'none';
    });

    // Add step button handler
    addStepBtn.addEventListener('click', () => {
        const stepsCount = document.querySelectorAll('.recipe-step').length;
        const newStep = document.createElement('div');
        newStep.className = 'recipe-item';
        newStep.innerHTML = `
                <input type="text" class="form-control recipe-step" placeholder="Step ${stepsCount + 1}" required>
                <button type="button" class="btn btn-danger remove-step">X</button>
            `;
        recipeSteps.appendChild(newStep);

        // Add event listener to new remove button
        newStep.querySelector('.remove-step').addEventListener('click', function() {
            if (document.querySelectorAll('.recipe-item').length > 1) {
                this.parentElement.remove();
                updateStepPlaceholders();
            }
        });
    });

    // Remove step handler (for initial step)
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-step')) {
            if (document.querySelectorAll('.recipe-item').length > 1) {
                e.target.parentElement.remove();
                updateStepPlaceholders();
            }
        }
    });

    // Update placeholders for recipe steps
    function updateStepPlaceholders() {
        const steps = document.querySelectorAll('.recipe-step');
        steps.forEach((step, index) => {
            step.setAttribute('placeholder', `Step ${index + 1}`);
        });
    }

    // Preview food photo
    foodPhotoUrl.addEventListener('input', function() {
        const url = this.value.trim();
        if (url) {
            foodPhotoPreview.src = url;
            foodPhotoPreview.classList.remove('hidden');

            // Handle image load error
            foodPhotoPreview.onerror = function() {
                this.classList.add('hidden');
            };

            // Handle image load success
            foodPhotoPreview.onload = function() {
                this.classList.remove('hidden');
            };
        } else {
            foodPhotoPreview.classList.add('hidden');
        }
    });

    // Food form submission
    foodForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const foodId = document.getElementById('foodId').value;
        const foodName = document.getElementById('foodName').value;
        const foodDescription = document.getElementById('foodDescription').value;
        const photoUrl = document.getElementById('foodPhotoUrl').value;
        const price = parseFloat(document.getElementById('foodPrice').value);
        const prepTimeMinutes = parseInt(document.getElementById('foodPrepTime').value);
        const categoryId = document.getElementById('foodCategory').value;

        // Get recipe steps
        const recipeStepsElements = document.querySelectorAll('.recipe-step');
        const recipe = Array.from(recipeStepsElements).map(step => step.value);

        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            let url, method, body;

            if (foodId) {
                // Update existing food
                url = `${API_BASE_URL}/Food/UpdateFood/${foodId}`;
                method = 'PUT';
                body = JSON.stringify({
                    name: foodName,
                    description: foodDescription,
                    photoUrl: photoUrl,
                    price: price,
                    preparationTime: `${prepTimeMinutes}:00`,
                    recipe: recipe
                });
            } else {
                // Create new food
                url = `${API_BASE_URL}/Food/CreateFood`;
                method = 'POST';
                body = JSON.stringify({
                    name: foodName,
                    description: foodDescription,
                    photoUrl: photoUrl,
                    price: price,
                    preparationTime: `${prepTimeMinutes}:00`,
                    recipe: recipe,
                    categoryId: categoryId
                });
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: body
            });

            if (response.ok) {
                foodModal.style.display = 'none';
                loadFoods();
                loadDashboardData();
            } else {
                const errorData = await response.text();
                alert(`Error: ${errorData}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    });

    // Grant admin role form submission
    grantAdminForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('adminUsername').value;

        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/Auth/GiveAdminRole`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ userName: username })
            });

            const result = await response.text();

            if (response.ok) {
                adminRoleMessage.innerHTML = `<div class="alert alert-success">Admin role successfully granted to ${username}</div>`;
                document.getElementById('adminUsername').value = '';
            } else {
                adminRoleMessage.innerHTML = `<div class="alert alert-danger">Error: ${result}</div>`;
            }
        } catch (error) {
            adminRoleMessage.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });

    // Load categories for dashboard
    async function loadCategories() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/Category/GetAllCategories`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const categories = await response.json();
                renderCategories(categories);
            } else {
                const error = await response.text();
                alert(`Error loading categories: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Render categories table
    function renderCategories(categories) {
        const tbody = categoriesTable.querySelector('tbody');
        tbody.innerHTML = '';

        if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">No categories found</td></tr>';
            return;
        }

        categories.forEach(category => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td>${category.id}</td>
                    <td>${category.name}</td>
                    <td class="actions-col">
                        <button class="btn btn-accent edit-category" data-id="${category.id}" data-name="${category.name}">Edit</button>
                        <button class="btn btn-danger delete-category" data-id="${category.id}">Delete</button>
                    </td>
                `;
            tbody.appendChild(tr);
        });

        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-category').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');

                categoryModalTitle.textContent = 'Edit Category';
                document.getElementById('categoryId').value = id;
                document.getElementById('categoryName').value = name;
                categoryModal.style.display = 'block';
            });
        });

        document.querySelectorAll('.delete-category').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (confirm('Are you sure you want to delete this category?')) {
                    const id = this.getAttribute('data-id');
                    await deleteCategory(id);
                }
            });
        });
    }

    // Delete category
    async function deleteCategory(id) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/Category/DeleteCategory/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                loadCategories();
                loadDashboardData();
            } else {
                const error = await response.text();
                alert(`Error deleting category: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Load foods for dashboard
    async function loadFoods() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            // Get foods
            const foodResponse = await fetch(`${API_BASE_URL}/Food/GetAllFoods`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            // Get categories for mapping
            const categoryResponse = await fetch(`${API_BASE_URL}/Category/GetAllCategories`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (foodResponse.ok && categoryResponse.ok) {
                const foods = await foodResponse.json();
                const categories = await categoryResponse.json();

                // Create category map for lookup
                const categoryMap = {};
                categories.forEach(category => {
                    categoryMap[category.id] = category.name;
                });

                renderFoods(foods, categoryMap);
            } else {
                alert('Error loading data');
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Render foods table
    function renderFoods(foods, categoryMap) {
        const tbody = foodsTable.querySelector('tbody');
        tbody.innerHTML = '';

        if (foods.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No foods found</td></tr>';
            return;
        }

        foods.forEach(food => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td><img src="${food.photoUrl}" alt="${food.name}" class="food-table-img" onerror="this.src='https://via.placeholder.com/80?text=No+Image'"></td>
                    <td>${food.name}</td>
                    <td>${food.price.toFixed(2)}</td>
                    <td>${categoryMap[food.categoryId] || 'Unknown'}</td>
                    <td class="actions-col">
                        <button class="btn btn-accent edit-food" data-id="${food.id}">Edit</button>
                        <button class="btn btn-danger delete-food" data-id="${food.id}">Delete</button>
                    </td>
                `;
            tbody.appendChild(tr);
        });

        // Add event listeners to edit and delete buttons
        document.querySelectorAll('.edit-food').forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.getAttribute('data-id');
                await loadFoodDetails(id);
            });
        });

        document.querySelectorAll('.delete-food').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (confirm('Are you sure you want to delete this food?')) {
                    const id = this.getAttribute('data-id');
                    await deleteFood(id);
                }
            });
        });
    }

    // Load food details for editing
    async function loadFoodDetails(id) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/Food/GetFoodById/${id}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const food = await response.json();

                foodModalTitle.textContent = 'Edit Food';
                document.getElementById('foodId').value = food.id;
                document.getElementById('foodName').value = food.name;
                document.getElementById('foodDescription').value = food.description;
                document.getElementById('foodPhotoUrl').value = food.photoUrl;
                document.getElementById('foodPrice').value = food.price;

                // Parse preparation time (format: HH:MM:SS)
                const prepTimeParts = food.preparationTime.split(':');
                const prepTimeMinutes = parseInt(prepTimeParts[0]) * 60 + parseInt(prepTimeParts[1]);
                document.getElementById('foodPrepTime').value = prepTimeMinutes;

                document.getElementById('foodCategory').value = food.categoryId;

                // Set recipe steps
                recipeSteps.innerHTML = '';
                food.recipe.forEach((step, index) => {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'recipe-item';
                    stepElement.innerHTML = `
                            <input type="text" class="form-control recipe-step" placeholder="Step ${index + 1}" value="${step}" required>
                            <button type="button" class="btn btn-danger remove-step">X</button>
                        `;
                    recipeSteps.appendChild(stepElement);
                });

                // If there are no steps, add an empty one
                if (food.recipe.length === 0) {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'recipe-item';
                    stepElement.innerHTML = `
                            <input type="text" class="form-control recipe-step" placeholder="Step 1" required>
                            <button type="button" class="btn btn-danger remove-step">X</button>
                        `;
                    recipeSteps.appendChild(stepElement);
                }

                // Preview image
                if (food.photoUrl) {
                    foodPhotoPreview.src = food.photoUrl;
                    foodPhotoPreview.classList.remove('hidden');
                } else {
                    foodPhotoPreview.classList.add('hidden');
                }

                foodModal.style.display = 'block';
            } else {
                const error = await response.text();
                alert(`Error loading food details: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Delete food
    async function deleteFood(id) {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/Food/DeleteFood/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                loadFoods();
                loadDashboardData();
            } else {
                const error = await response.text();
                alert(`Error deleting food: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Load categories for food dropdown
    async function loadCategoriesForDropdown() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/Category/GetAllCategories`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const categories = await response.json();
                const dropdown = document.getElementById('foodCategory');

                // Clear previous options except the first one
                dropdown.innerHTML = '<option value="">Select Category</option>';

                // Add categories to dropdown
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    dropdown.appendChild(option);
                });
            } else {
                const error = await response.text();
                alert(`Error loading categories: ${error}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Function to load all orders
    function loadOrders() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        fetch(`${API_BASE_URL}/Order/GetOrders`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to load orders');
                return response.json();
            })
            .then(orders => {
                displayOrders(orders);
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                alert('Failed to load orders. Please try again.');
            });
    }

    // Function to display orders in the table
    function displayOrders(orders) {
        const tableBody = document.querySelector('#ordersTable tbody');
        tableBody.innerHTML = '';

        if (orders.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No orders found</td></tr>';
            return;
        }

        orders.forEach(order => {
            const row = document.createElement('tr');

            // Truncate order ID for display
            const shortOrderId = order.id.substring(0, 8) + '...';

            // Convert status string to number if needed
            const statusNumber = getStatusNumber(order.status);

            row.innerHTML = `
                    <td title="${order.id}">${shortOrderId}</td>
                    <td>${order.items ? order.items.length : 0} items</td>
                    <td class="order-status-cell">
                        <div>
                            <span class="status-badge status-${getStatusClass(statusNumber)}">
                                ${STATUS_TEXT[statusNumber] || order.status}
                            </span>
                        </div>
                        <input 
                            type="range" 
                            class="status-slider" 
                            min="0" 
                            max="2" 
                            value="${statusNumber}" 
                            data-order-id="${order.id}"
                        >
                    </td>
                `;

            tableBody.appendChild(row);
        });

        // Add event listeners to all sliders
        document.querySelectorAll('.status-slider').forEach(slider => {
            slider.addEventListener('change', updateOrderStatus);
        });
    }

    // Function to get status class for styling
    function getStatusClass(status) {
        switch (parseInt(status)) {
            case ORDER_STATUS.PREPARING:
                return 'preparing';
            case ORDER_STATUS.DELIVERING:
                return 'delivering';
            case ORDER_STATUS.DELIVERED:
                return 'delivered';
            default:
                return 'preparing';
        }
    }

    function getStatusNumber(statusString) {
        if (typeof statusString === 'number') return statusString;

        switch (statusString) {
            case 'Preparing':
                return ORDER_STATUS.PREPARING;
            case 'Delivered':
                return ORDER_STATUS.DELIVERED;
            case 'Delivering':
                return ORDER_STATUS.DELIVERING;
            default:
                return ORDER_STATUS.PREPARING;
        }
    }


    // Function to update order status
    function updateOrderStatus(event) {
        const slider = event.target;
        const orderId = slider.dataset.orderId;
        const newStatus = slider.value;

        // Find the status badge to update it immediately
        const statusBadge = slider.parentElement.querySelector('.status-badge');

        // Update the API
        fetch(`${API_BASE_URL}/Order/UpdateOrderStatus/${orderId}?newStatus=${newStatus}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update status');

                // Update the status badge
                statusBadge.className = `status-badge status-${getStatusClass(newStatus)}`;
                statusBadge.textContent = STATUS_TEXT[newStatus];

                // Show success message
                showMessage('Order status updated successfully!', 'success');
            })
            .catch(error => {
                console.error('Error updating order status:', error);

                // Revert the slider value
                slider.value = statusBadge.textContent === 'Preparing' ? 0 :
                    statusBadge.textContent === 'Delivering' ? 1 : 2;

                // Show error message
                showMessage('Failed to update order status. Please try again.', 'danger');
            });
    }

    // Function to view order details (for future implementation)
    function viewOrderDetails(orderId) {
        alert(`View details for order: ${orderId}`);
        // Implement order details modal or page here
    }

    // Show message function
    function showMessage(message, type = 'success') {
        const messageElement = document.createElement('div');
        messageElement.className = `alert alert-${type}`;
        messageElement.textContent = message;

        const mainContent = document.querySelector('.main-content');
        mainContent.insertBefore(messageElement, mainContent.firstChild);

        // Remove the message after 3 seconds
        setTimeout(() => {
            messageElement.remove();
        }, 3000);
    }

    // Load dashboard data
    async function loadDashboardData() {
        const token = localStorage.getItem('adminToken');
        if (!token) {
            showLoginPage();
            return;
        }

        try {
            // Get categories count
            const categoryResponse = await fetch(`${API_BASE_URL}/Category/GetAllCategories`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            // Get foods count
            const foodResponse = await fetch(`${API_BASE_URL}/Food/GetAllFoods`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (categoryResponse.ok && foodResponse.ok) {
                const categories = await categoryResponse.json();
                const foods = await foodResponse.json();

                categoryCount.textContent = categories.length;
                foodCount.textContent = foods.length;
            }
        } catch (error) {
            console.error(`Error loading dashboard data: ${error.message}`);
        }
    }

    // Helper functions
    function showAdminDashboard() {
        loginPage.classList.add('hidden');
        adminDashboard.classList.remove('hidden');
    }

    function showLoginPage() {
        adminDashboard.classList.add('hidden');
        loginPage.classList.remove('hidden');
        loginForm.reset();
    }
</script>>
</body>
</html>